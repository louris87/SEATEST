<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SeamanAgency - Command Center</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <style>
    :root {
      /* Navy Theme Colors */
      --navy-dark: #0a192f;
      --navy-medium: #112240;
      --navy-light: #233554;
      --navy-card: #172a45;
      --white: #e6f1ff;
      --off-white: #ccd6f6;
      --light-gray: #8892b0;
      --blue-accent: #64ffda;
      --blue-light: #57cbff;
      --blue-primary: #3a86ff;
      --red-alert: #ff6b6b;
      --green-success: #4ecdc4;
      --yellow-warning: #ffd166;
      
      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-xxl: 48px;
      
      /* Borders */
      --border-radius: 8px;
      --border-radius-lg: 12px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background-color: var(--navy-dark);
      color: var(--white);
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        linear-gradient(rgba(10, 25, 47, 0.95), rgba(10, 25, 47, 0.95)),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23172a45" stroke-width="0.5"/></svg>');
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: var(--spacing-xl);
    }
    
    /* Header */
    header {
      background-color: var(--navy-medium);
      border-bottom: 2px solid var(--blue-primary);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--spacing-md);
      flex-wrap: wrap;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .logo-icon {
      background-color: var(--blue-primary);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }
    
    .logo-text {
      font-size: 24px;
      font-weight: 700;
      color: var(--white);
      letter-spacing: 0.5px;
    }
    
    .logo-text span {
      color: var(--blue-light);
    }
    
    .sync-status {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 14px;
      background-color: var(--navy-card);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 20px;
      border: 1px solid var(--navy-light);
    }
    
    .sync-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--green-success);
    }
    
    .sync-indicator.syncing {
      background-color: var(--yellow-warning);
      animation: pulse 1.5s infinite;
    }
    
    .sync-indicator.error {
      background-color: var(--red-alert);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    #userEmail {
      font-size: 14px;
      color: var(--light-gray);
      background-color: var(--navy-card);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 20px;
      border: 1px solid var(--navy-light);
    }
    
    /* Buttons */
    .btn-group {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      letter-spacing: 0.5px;
    }
    
    .btn-primary {
      background-color: var(--blue-primary);
      color: white;
      border: 2px solid var(--blue-primary);
    }
    
    .btn-primary:hover {
      background-color: transparent;
      color: var(--blue-light);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(58, 134, 255, 0.2);
    }
    
    .btn-secondary {
      background-color: transparent;
      color: var(--off-white);
      border: 2px solid var(--navy-light);
    }
    
    .btn-secondary:hover {
      background-color: var(--navy-light);
      border-color: var(--blue-light);
      transform: translateY(-2px);
    }
    
    .logout-btn {
      background-color: transparent;
      border: 2px solid var(--red-alert);
      color: var(--red-alert);
      padding: 8px 16px;
      font-size: 13px;
    }
    
    .logout-btn:hover {
      background-color: var(--red-alert);
      color: white;
    }
    
    /* Card Action Buttons */
    .btn-edit {
      background-color: transparent;
      border: 2px solid var(--blue-light);
      color: var(--blue-light);
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }
    
    .btn-edit:hover {
      background-color: var(--blue-light);
      color: white;
    }
    
    .btn-delete {
      background-color: transparent;
      border: 2px solid var(--red-alert);
      color: var(--red-alert);
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }
    
    .btn-delete:hover {
      background-color: var(--red-alert);
      color: white;
    }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: var(--spacing-xxl);
      background-color: var(--navy-card);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--navy-light);
      margin: var(--spacing-xl) 0;
    }
    
    .spinner {
      border: 4px solid var(--navy-light);
      border-top: 4px solid var(--blue-primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--spacing-md);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Containers */
    .search-container,
    .form-container,
    .login-container,
    .title-dialog {
      background-color: var(--navy-card);
      border: 1px solid var(--navy-light);
      padding: var(--spacing-xl);
      border-radius: var(--border-radius-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    /* Form Elements */
    input,
    select,
    textarea {
      width: 100%;
      padding: 12px 16px;
      background-color: var(--navy-medium);
      border: 1px solid var(--navy-light);
      border-radius: var(--border-radius);
      color: var(--white);
      font-size: 14px;
      transition: all 0.3s;
      margin-top: 4px;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--blue-primary);
      box-shadow: 0 0 0 2px rgba(58, 134, 255, 0.2);
    }
    
    label {
      color: var(--light-gray);
      font-size: 12px;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      display: block;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .search-container {
      display: none;
    }
    
    .search-box {
      display: flex;
      gap: var(--spacing-md);
    }
    
    .form-container {
      display: none;
    }
    
    .form-title {
      font-size: 24px;
      margin-bottom: var(--spacing-xl);
      color: var(--white);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--navy-light);
    }
    
    .form-title i {
      color: var(--blue-primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
    }
    
    /* Checkbox Groups */
    .checkbox-group {
      background-color: var(--navy-medium);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      border: 1px solid var(--navy-light);
      margin-top: var(--spacing-lg);
    }
    
    .checkbox-section-title {
      color: var(--off-white);
      border-bottom: 1px solid var(--navy-light);
      padding-bottom: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      font-size: 16px;
      font-weight: 600;
    }
    
    .checkbox-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--spacing-md);
    }
    
    .checkbox-item label {
      text-transform: none;
      letter-spacing: normal;
      color: var(--off-white);
      cursor: pointer;
      font-weight: 400;
      font-size: 14px;
    }
    
    .checkbox-item input[type="checkbox"] {
      margin-right: var(--spacing-sm);
      transform: scale(1.1);
      accent-color: var(--blue-primary);
    }
    
    /* Login */
    .login-container {
      display: none;
      max-width: 400px;
      margin: 10vh auto;
      text-align: center;
      border-top: 4px solid var(--blue-primary);
    }
    
    .login-container h2 {
      margin-bottom: var(--spacing-xl);
      color: var(--white);
      font-size: 28px;
    }
    
    .login-btn {
      width: 100%;
      justify-content: center;
      margin-top: var(--spacing-lg);
      padding: 14px;
    }
    
    /* Profile Cards */
    .profile-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: var(--spacing-lg);
    }
    
    .profile-card {
      background-color: var(--navy-card);
      border: 1px solid var(--navy-light);
      border-radius: var(--border-radius-lg);
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .profile-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      border-color: var(--blue-light);
    }
    
    .card-header {
      background-color: var(--navy-medium);
      padding: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--navy-light);
    }
    
    .card-header-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }
    
    .card-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--blue-primary), var(--blue-light));
      border-radius: var(--border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: 600;
    }
    
    .card-header h3 {
      font-size: 18px;
      color: var(--white);
      margin-bottom: 4px;
    }
    
    .card-header p {
      color: var(--blue-light);
      font-size: 13px;
      font-weight: 600;
    }
    
    .card-actions {
      display: flex;
      gap: var(--spacing-sm);
    }
    
    .card-body {
      padding: var(--spacing-lg);
    }
    
    .card-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px dashed var(--navy-light);
      font-size: 14px;
    }
    
    .card-detail:last-child {
      border-bottom: none;
    }
    
    .detail-label {
      color: var(--light-gray);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .detail-value {
      color: var(--off-white);
      font-weight: 500;
      text-align: right;
    }
    
    /* Progress Bar */
    .progress-bar {
      height: 6px;
      background-color: var(--navy-medium);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .progress {
      height: 100%;
      background: linear-gradient(90deg, var(--blue-primary), var(--blue-light));
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    
    /* No Results */
    .no-results {
      grid-column: 1 / -1;
      text-align: center;
      padding: var(--spacing-xxl);
      color: var(--light-gray);
      background-color: var(--navy-medium);
      border-radius: var(--border-radius-lg);
      border: 2px dashed var(--navy-light);
    }
    
    .no-results i {
      font-size: 40px;
      margin-bottom: var(--spacing-md);
      opacity: 0.5;
      color: var(--blue-light);
    }
    
    /* Footer */
    footer {
      text-align: center;
      margin-top: var(--spacing-xxl);
      padding: var(--spacing-xl);
      color: var(--light-gray);
      font-size: 13px;
      border-top: 1px solid var(--navy-light);
      background-color: var(--navy-medium);
      border-radius: var(--border-radius);
    }
    
    /* Title Dialog */
    .title-dialog {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      text-align: center;
    }
    
    .title-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-lg);
      margin-top: var(--spacing-xl);
    }
    
    .title-option {
      background-color: var(--navy-medium);
      border: 2px solid var(--navy-light);
      border-radius: var(--border-radius);
      padding: var(--spacing-xl) var(--spacing-lg);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .title-option:hover {
      background-color: var(--navy-card);
      border-color: var(--blue-light);
      transform: translateY(-4px);
    }
    
    .title-option.active {
      background-color: var(--navy-card);
      border-color: var(--blue-primary);
      box-shadow: 0 4px 12px rgba(58, 134, 255, 0.2);
    }
    
    .title-option i {
      font-size: 36px;
      margin-bottom: var(--spacing-md);
      color: var(--blue-primary);
    }
    
    .title-option h3,
    .title-option h4 {
      color: var(--white);
      margin-bottom: 6px;
    }
    
    .title-option p {
      color: var(--light-gray);
      font-size: 13px;
    }
    
    /* Sub Options */
    .sub-options {
      display: none;
      margin-top: var(--spacing-lg);
      padding: var(--spacing-lg);
      background-color: var(--navy-medium);
      border-radius: var(--border-radius);
      border: 1px solid var(--navy-light);
    }
    
    .sub-options.active {
      display: block;
    }
    
    /* Webcam */
    .webcam-container {
      grid-column: 1 / -1;
      background-color: var(--navy-medium);
      padding: var(--spacing-lg);
      border-radius: var(--border-radius);
      border: 1px solid var(--navy-light);
      margin-top: var(--spacing-lg);
    }
    
    .webcam-preview {
      width: 100%;
      max-width: 400px;
      height: 300px;
      background-color: var(--navy-card);
      border-radius: var(--border-radius);
      margin: 0 auto var(--spacing-md);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 2px solid var(--navy-light);
    }
    
    .webcam-preview video,
    .webcam-preview canvas,
    .webcam-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: calc(var(--border-radius) - 2px);
    }
    
    .webcam-controls {
      display: flex;
      justify-content: center;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    
    /* Date Search */
    .date-search {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }
    
    .date-search input {
      flex: 1;
    }
    
    /* Utility Classes */
    .hidden-field {
      display: none;
    }
    
    /* Text Colors */
    .text-primary { color: var(--blue-primary); }
    .text-success { color: var(--green-success); }
    .text-warning { color: var(--yellow-warning); }
    .text-danger { color: var(--red-alert); }
    .text-info { color: var(--blue-light); }
    .text-muted { color: var(--light-gray); }
    
    /* Form Actions */
    .form-actions {
      text-align: center;
      margin-top: var(--spacing-xl);
      display: flex;
      justify-content: center;
      gap: var(--spacing-md);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">
            <i class="fa-solid fa-anchor"></i>
          </div>
          <div class="logo-text">BEST FRIEND <span>SEAMAN AGENCY</span></div>
        </div>
        <div class="sync-status">
          <div class="sync-indicator" id="syncIndicator"></div>
          <span id="syncStatus">System Initializing...</span>
        </div>
        <div class="user-info" id="userInfo" style="display:none">
          <span id="userEmail">user@example.com</span>
          <button id="logoutBtn" class="logout-btn"><i class="fa-solid fa-power-off"></i> Logout</button>
        </div>
      </div>
    </header>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p id="loadingText">Processing data...</p>
    </div>

    <div id="loginContainer" class="login-container">
      <h2>Welcome Back</h2>
      <form id="loginForm" class="login-form">
        <div class="form-group" style="margin-bottom:20px;text-align:left">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="Enter your email" required/>
        </div>
        <div class="form-group" style="margin-bottom:20px;text-align:left">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required/>
        </div>
        <button type="submit" class="login-btn btn-primary">Access System</button>
      </form>
    </div>

    <div id="mainContent" style="display:none">
      <div class="btn-group">
        <button id="addDataBtn" class="btn-primary"><i class="fa-solid fa-plus"></i> Add Profile</button>
        <button id="searchBtn" class="btn-secondary"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
        <button id="exportBtn" class="btn-secondary" style="margin-left:auto"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
      </div>

      <div id="searchContainer" class="search-container">
        <h3 style="margin-bottom:15px; color: var(--white)">Search Database</h3>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Type name, rank, or CDC number..."/>
          <button id="searchSubmit" class="btn-primary">Search</button>
        </div>
        <div class="date-search">
          <input type="date" id="dateFrom" placeholder="From Date"/>
          <input type="date" id="dateTo" placeholder="To Date"/>
          <button id="dateSearch" class="btn-secondary">Search by Date</button>
        </div>
      </div>

      <!-- Title Selection Dialog -->
      <div id="titleDialog" class="title-dialog">
        <h2 class="form-title"><i class="fa-solid fa-file-lines"></i> Select Document Type</h2>
        <div class="title-options">
          <div class="title-option" id="newCDCOption">
            <i class="fa-solid fa-file-circle-plus"></i>
            <h3>NEW CDC</h3>
            <p>Create new CDC document</p>
          </div>
          <div class="title-option" id="revalidationOption">
            <i class="fa-solid fa-file-pen"></i>
            <h3>REVALIDATION</h3>
            <p>Update existing CDC</p>
          </div>
        </div>

        <div class="sub-options" id="revalidationSubOptions">
          <h4 style="color: var(--white); margin-bottom: 15px; font-size: 16px;">Select Revalidation Type</h4>
          <div class="title-options" style="grid-template-columns:1fr 1fr;margin-top:15px">
            <div class="title-option" id="crewOption">
              <i class="fa-solid fa-user"></i>
              <h4>CREW</h4>
            </div>
            <div class="title-option" id="officerOption">
              <i class="fa-solid fa-user-tie"></i>
              <h4>OFFICER</h4>
            </div>
          </div>

          <!-- Dialog-only docs -->
          <div class="checkbox-group hidden-field" id="crewDocsTemplate">
            <div class="checkbox-section-title">Crew Documents</div>
            <div class="checkbox-row">
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="4-Ticket" id="crew_4ticket"><label for="crew_4ticket">4-Ticket</label></div>
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="PSC" id="crew_psc"><label for="crew_psc">PSC</label></div>
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="TANKER" id="crew_TANKER"><label for="crew_TANKER">TANKER</label></div>
              <div class="checkbox-item"><input type="checkbox" name="crewCertificates" value="CMC" id="crew_cmc"><label for="crew_cmc">CMC</label></div>
            </div>
          </div>

          <div class="checkbox-group hidden-field" id="officerDocsTemplate">
            <div class="checkbox-section-title">Officer Documents</div>
            <div class="checkbox-row">
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="AFF" id="off_aff"><label for="off_aff">AFF</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="PSC" id="off_psc"><label for="off_psc">PSC</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="MFA" id="off_mfa"><label for="off_mfa">MFA</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="CMC" id="off_cmc"><label for="off_cmc">CMC</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="G.O.C" id="off_gdc"><label for="off_gdc">G.O.C</label></div>
              <div class="checkbox-item"><input type="checkbox" name="officerCertificates" value="C.O.C" id="off_cdc"><label for="off_cdc">C.O.C</label></div>
            </div>
          </div>
        </div>

        <div style="margin-top:30px; display: flex; gap: 15px; justify-content: center;">
          <button id="confirmTitle" class="btn-primary">Confirm Selection</button>
          <button id="cancelTitle" class="btn-secondary">Cancel</button>
        </div>
      </div>

      <!-- Main Form Container -->
      <div id="formContainer" class="form-container">
        <h2 class="form-title"><i class="fa-solid fa-user-pen"></i> <span id="formTitleText">New Profile Registration</span></h2>
        <form id="profileForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="name">Full Name</label>
              <input type="text" id="name" required/>
            </div>
            <div class="form-group">
              <label for="rank">Rank</label>
              <select id="rank" required>
                <option value="">Select Rank</option>
              </select>
            </div>
            <div class="form-group">
              <label for="cdcNumber">CDC Number</label>
              <input type="text" id="cdcNumber" required/>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" required/>
            </div>
            <div class="form-group">
              <label for="address">Address</label>
              <textarea id="address" required rows="1"></textarea>
            </div>
            <div class="form-group">
              <label for="passportNumber">Passport Number</label>
              <input type="text" id="passportNumber"/>
            </div>
            <div class="form-group">
              <label for="passportExpiry">Passport Expiry Date</label>
              <input type="text" id="passportExpiry" placeholder="DD/MM/YYYY"/>
            </div>

            <!-- NEW CDC Only -->
            <div class="form-group hidden-field new-cdc-only">
              <label for="nrc">NRC Number</label>
              <input type="text" id="nrc" placeholder="e.g., 12/ABC(N)123456"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="fatherName">Father's Name</label>
              <input type="text" id="fatherName"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="motherName">Mother's Name</label>
              <input type="text" id="motherName"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="birthdate">Birthdate (DD/MM/YYYY)</label>
              <input type="text" id="birthdate" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="placeOfBirth">Place of Birth</label>
              <input type="text" id="placeOfBirth" placeholder="e.g., Yangon, Myanmar"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="distinguishingMark">Distinguishing Mark</label>
              <input type="text" id="distinguishingMark" placeholder="Visible marks"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="fees">Fees Amount ($)</label>
              <input type="number" id="fees"/>
            </div>
            <div class="form-group hidden-field new-cdc-only">
              <label for="feesPercentage">Payment Status (%)</label>
              <input type="number" id="feesPercentage" min="0" max="100"/>
              <div class="progress-bar"><div class="progress" id="feesProgress"></div></div>
            </div>

            <div class="form-group" style="grid-column:1/-1">
              <label for="remark">Remark</label>
              <textarea id="remark" rows="3" placeholder="Additional notes..."></textarea>
            </div>
          </div>

          <!-- Webcam -->
          <div class="webcam-container">
            <div class="checkbox-section-title">Profile Photo</div>
            <div class="webcam-preview" id="webcamPreview">
              <i class="fa-solid fa-camera" style="font-size:50px;opacity:.5; color: var(--light-gray)"></i>
            </div>
            <div class="webcam-controls">
              <button type="button" id="startCamera" class="btn-secondary"><i class="fa-solid fa-camera"></i> Start Camera</button>
              <button type="button" id="capturePhoto" class="btn-secondary" disabled><i class="fa-solid fa-camera-retro"></i> Capture</button>
              <button type="button" id="retakePhoto" class="btn-secondary" disabled><i class="fa-solid fa-rotate-left"></i> Retake</button>
            </div>
            <input type="hidden" id="profilePhoto"/>
          </div>

          <!-- Revalidation docs -->
          <div id="revalidationDocsContainer" class="checkbox-group hidden-field"></div>

          <!-- NEW CDC docs -->
          <div class="checkbox-group hidden-field new-cdc-only">
            <div class="checkbox-section">
              <div class="checkbox-section-title">Core Documents</div>
              <div class="checkbox-row">
                <div class="checkbox-item"><input type="checkbox" id="bst" name="certificates" value="BST"><label for="bst">BST</label></div>
                <div class="checkbox-item"><input type="checkbox" id="pd" name="certificates" value="PD"><label for="pd">PD</label></div>
                <div class="checkbox-item"><input type="checkbox" id="pe" name="certificates" value="PE"><label for="pe">PE</label></div>
                <div class="checkbox-item"><input type="checkbox" id="cck" name="certificates" value="CCK"><label for="cck">CCK</label></div>
              </div>
            </div>
            <div class="checkbox-section">
              <div class="checkbox-section-title">Additional Docs</div>
              <div class="checkbox-row">
                <div class="checkbox-item"><input type="checkbox" id="ssa" name="certificates" value="SSA"><label for="ssa">SSA</label></div>
                <div class="checkbox-item"><input type="checkbox" id="dsd" name="certificates" value="DSD"><label for="dsd">DSD</label></div>
                <div class="checkbox-item"><input type="checkbox" id="cdc" name="certificates" value="CDC"><label for="cdc">CDC</label></div>
                <div class="checkbox-item"><input type="checkbox" id="cmc" name="certificates" value="CMC"><label for="cmc">CMC</label></div>
              </div>
            </div>
            <div class="checkbox-section">
              <div class="checkbox-section-title">Special</div>
              <div class="checkbox-row">
                <div class="checkbox-item"><input type="checkbox" id="pscSpecial" name="certificates" value="PSC"><label for="pscSpecial">PSC</label></div>
                <div class="checkbox-item"><input type="checkbox" id="tff" name="certificates" value="TFF"><label for="tff">TFF</label></div>
                <div class="checkbox-item"><input type="checkbox" id="aio" name="certificates" value="AIO"><label for="aio">AIO</label></div>
                <div class="checkbox-item"><input type="checkbox" id="sid" name="certificates" value="SID"><label for="sid">SID</label></div>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" id="saveBtn"><i class="fa-solid fa-save"></i> Save Record</button>
            <button type="button" id="cancelBtn" class="btn-secondary">Cancel</button>
            <button type="button" id="updateBtn" class="btn-primary hidden-field"><i class="fa-solid fa-edit"></i> Update Record</button>
          </div>
        </form>
      </div>

      <div id="profileCards" class="profile-cards">
        <div class="no-results" id="noResults">
          <i class="fa-solid fa-cloud-arrow-down"></i><br/>
          Connecting to Database...
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 BEST FRIEND SEAMAN AGENCY. All rights reserved.</p>
    </footer>
  </div>

  <script>
    const firebaseConfig={
      apiKey:"AIzaSyDP34-uI6YNf56YUax0zLQ7y_TWad52rA0",
      authDomain:"seameandatabase.firebaseapp.com",
      projectId:"seameandatabase",
      storageBucket:"seameandatabase.firebasestorage.app",
      messagingSenderId:"1078604355486",
      appId:"G-16GVDL26Q3"
    };

    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    const auth=firebase.auth();

    let profiles=[];
    let selectedTitle='';
    let selectedRevalidationType='';
    let stream=null;
    let capturedPhoto=null;
    let editingProfileId = null;

    const loading=document.getElementById('loading');
    const loadingText=document.getElementById('loadingText');
    const syncIndicator=document.getElementById('syncIndicator');
    const syncStatus=document.getElementById('syncStatus');
    const loginContainer=document.getElementById('loginContainer');
    const loginForm=document.getElementById('loginForm');
    const mainContent=document.getElementById('mainContent');
    const userInfo=document.getElementById('userInfo');
    const userEmail=document.getElementById('userEmail');
    const logoutBtn=document.getElementById('logoutBtn');
    const exportBtn=document.getElementById('exportBtn');
    const addDataBtn=document.getElementById('addDataBtn');
    const searchBtn=document.getElementById('searchBtn');
    const searchContainer=document.getElementById('searchContainer');
    const formContainer=document.getElementById('formContainer');
    const profileForm=document.getElementById('profileForm');
    const profileCards=document.getElementById('profileCards');
    const searchInput=document.getElementById('searchInput');
    const searchSubmit=document.getElementById('searchSubmit');
    const dateFrom=document.getElementById('dateFrom');
    const dateTo=document.getElementById('dateTo');
    const dateSearch=document.getElementById('dateSearch');
    const cancelBtn=document.getElementById('cancelBtn');
    const noResults=document.getElementById('noResults');
    const feesPercentage=document.getElementById('feesPercentage');
    const feesProgress=document.getElementById('feesProgress');
    const formTitleText = document.getElementById('formTitleText');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');

    const titleDialog=document.getElementById('titleDialog');
    const newCDCOption=document.getElementById('newCDCOption');
    const revalidationOption=document.getElementById('revalidationOption');
    const revalidationSubOptions=document.getElementById('revalidationSubOptions');
    const crewOption=document.getElementById('crewOption');
    const officerOption=document.getElementById('officerOption');
    const confirmTitle=document.getElementById('confirmTitle');
    const cancelTitle=document.getElementById('cancelTitle');

    const crewDocsTemplate=document.getElementById('crewDocsTemplate');
    const officerDocsTemplate=document.getElementById('officerDocsTemplate');
    const revalidationDocsContainer=document.getElementById('revalidationDocsContainer');

    const webcamPreview=document.getElementById('webcamPreview');
    const startCamera=document.getElementById('startCamera');
    const capturePhoto=document.getElementById('capturePhoto');
    const retakePhoto=document.getElementById('retakePhoto');
    const profilePhoto=document.getElementById('profilePhoto');
    const rankSelect=document.getElementById('rank');

    document.addEventListener('DOMContentLoaded',initApp);
    loginForm.addEventListener('submit',loginUser);
    logoutBtn.addEventListener('click',logoutUser);
    exportBtn.addEventListener('click',exportToCSV);
    addDataBtn.addEventListener('click',showTitleDialog);
    searchBtn.addEventListener('click',showSearch);
    profileForm.addEventListener('submit',saveProfile);
    searchSubmit.addEventListener('click',searchProfiles);
    dateSearch.addEventListener('click',searchByDate);
    cancelBtn.addEventListener('click',hideForm);
    updateBtn.addEventListener('click', updateProfile);
    feesPercentage.addEventListener('input',updateProgressBar);

    newCDCOption.addEventListener('click',()=>selectTitle('NEW CDC'));
    revalidationOption.addEventListener('click',()=>selectTitle('REVALIDATION'));
    crewOption.addEventListener('click',()=>selectRevalidationType('CREW'));
    officerOption.addEventListener('click',()=>selectRevalidationType('OFFICER'));
    confirmTitle.addEventListener('click',confirmTitleSelection);
    cancelTitle.addEventListener('click',hideTitleDialog);

    startCamera.addEventListener('click',startWebcam);
    capturePhoto.addEventListener('click',captureWebcam);
    retakePhoto.addEventListener('click',retakeWebcam);

    function initApp(){
      updateSyncStatus('Initializing Firebase...','syncing');
      auth.onAuthStateChanged(user=>{
        if(user){
          userEmail.textContent=user.email;
          userInfo.style.display='flex';
          loginContainer.style.display='none';
          mainContent.style.display='block';
          updateSyncStatus('System Online','connected');
          loadDataFromFirebase();
        }else{
          userInfo.style.display='none';
          loginContainer.style.display='block';
          mainContent.style.display='none';
          updateSyncStatus('Authentication Required','error');
        }
      });
    }

    async function loginUser(e){
      e.preventDefault();
      const email=document.getElementById('email').value;
      const password=document.getElementById('password').value;
      showLoading('Authenticating...');
      try{
        await auth.signInWithEmailAndPassword(email,password);
      }catch(err){
        alert('Login failed: '+err.message);
      }finally{hideLoading()}
    }

    async function logoutUser(){
      showLoading('Terminating session...');
      try{await auth.signOut()}catch(err){/* noop */}finally{hideLoading()}
    }

    function updateSyncStatus(message,status='connected'){
      syncStatus.textContent=message;
      syncIndicator.className='sync-indicator '+status;
    }

    async function loadDataFromFirebase(){
      showLoading('Fetching records...');
      try{
        const snapshot=await db.collection('profiles').orderBy('timestamp','desc').get();
        profiles=[];
        snapshot.forEach(doc=>{const p=doc.data();p.id=doc.id;profiles.push(p)});
        updateSyncStatus(`Online - ${profiles.length} Records`,'connected');
        displayProfiles(profiles);
      }catch(error){
        try{
          const snapshot=await db.collection('profiles').get();
          profiles=[];
          snapshot.forEach(doc=>{const p=doc.data();p.id=doc.id;profiles.push(p)});
          displayProfiles(profiles);
        }catch(e){
          updateSyncStatus('Connection Error','error');
        }
      }finally{hideLoading()}
    }

    async function saveProfile(e){
      e.preventDefault();
      const selectedCertificates=[];
      if(selectedTitle==='NEW CDC'){
        document.querySelectorAll('input[name="certificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
      }else if(selectedTitle==='REVALIDATION'){
        if(selectedRevalidationType==='CREW'){
          revalidationDocsContainer.querySelectorAll('input[name="crewCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }else if(selectedRevalidationType==='OFFICER'){
          revalidationDocsContainer.querySelectorAll('input[name="officerCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }
      }

      const profile={
        name:document.getElementById('name').value,
        rank:document.getElementById('rank').value,
        cdcNumber:document.getElementById('cdcNumber').value,
        phone:document.getElementById('phone').value,
        address:document.getElementById('address').value,
        passportNumber:document.getElementById('passportNumber').value,
        passportExpiry:document.getElementById('passportExpiry').value,
        remark:document.getElementById('remark').value,
        title:selectedTitle,
        revalidationType:selectedRevalidationType,
        profilePhoto:capturedPhoto,
        certificates:selectedCertificates.join(', '),
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
      };

      if(selectedTitle==='NEW CDC'){
        profile.nrc=document.getElementById('nrc').value;
        profile.fatherName=document.getElementById('fatherName').value;
        profile.motherName=document.getElementById('motherName').value;
        profile.birthdate=document.getElementById('birthdate').value;
        profile.placeOfBirth=document.getElementById('placeOfBirth').value;
        profile.distinguishingMark=document.getElementById('distinguishingMark').value;
        profile.fees=document.getElementById('fees').value;
        profile.feesPercentage=document.getElementById('feesPercentage').value;
      }

      showLoading('Uploading to cloud...');
      try{
        await db.collection('profiles').add(profile);
        alert('Success: Profile archived in database.');
        hideForm();
        await loadDataFromFirebase();
      }catch(err){
        alert('Error: '+err.message);
      }finally{hideLoading()}
    }

    async function updateProfile() {
      if (!editingProfileId) return;
      
      const selectedCertificates=[];
      if(selectedTitle==='NEW CDC'){
        document.querySelectorAll('input[name="certificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
      }else if(selectedTitle==='REVALIDATION'){
        if(selectedRevalidationType==='CREW'){
          revalidationDocsContainer.querySelectorAll('input[name="crewCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }else if(selectedRevalidationType==='OFFICER'){
          revalidationDocsContainer.querySelectorAll('input[name="officerCertificates"]:checked').forEach(cb=>selectedCertificates.push(cb.value));
        }
      }

      const profile={
        name:document.getElementById('name').value,
        rank:document.getElementById('rank').value,
        cdcNumber:document.getElementById('cdcNumber').value,
        phone:document.getElementById('phone').value,
        address:document.getElementById('address').value,
        passportNumber:document.getElementById('passportNumber').value,
        passportExpiry:document.getElementById('passportExpiry').value,
        remark:document.getElementById('remark').value,
        title:selectedTitle,
        revalidationType:selectedRevalidationType,
        profilePhoto:capturedPhoto || document.getElementById('profilePhoto').value,
        certificates:selectedCertificates.join(', '),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if(selectedTitle==='NEW CDC'){
        profile.nrc=document.getElementById('nrc').value;
        profile.fatherName=document.getElementById('fatherName').value;
        profile.motherName=document.getElementById('motherName').value;
        profile.birthdate=document.getElementById('birthdate').value;
        profile.placeOfBirth=document.getElementById('placeOfBirth').value;
        profile.distinguishingMark=document.getElementById('distinguishingMark').value;
        profile.fees=document.getElementById('fees').value;
        profile.feesPercentage=document.getElementById('feesPercentage').value;
      }

      showLoading('Updating profile...');
      try{
        await db.collection('profiles').doc(editingProfileId).update(profile);
        alert('Success: Profile updated.');
        hideForm();
        await loadDataFromFirebase();
      }catch(err){
        alert('Error: '+err.message);
      }finally{
        hideLoading();
        editingProfileId = null;
      }
    }

    async function deleteProfile(profileId) {
      if (!confirm('Are you sure you want to delete this profile?')) return;
      
      showLoading('Deleting profile...');
      try {
        await db.collection('profiles').doc(profileId).delete();
        profiles = profiles.filter(p => p.id !== profileId);
        displayProfiles(profiles);
        updateSyncStatus(`Online - ${profiles.length} Records`, 'connected');
        alert('Profile deleted successfully.');
      } catch (err) {
        alert('Error deleting profile: ' + err.message);
      } finally {
        hideLoading();
      }
    }

    function editProfile(profile) {
      editingProfileId = profile.id;
      selectedTitle = profile.title || '';
      selectedRevalidationType = profile.revalidationType || '';
      
      document.getElementById('name').value = profile.name || '';
      document.getElementById('rank').value = profile.rank || '';
      document.getElementById('cdcNumber').value = profile.cdcNumber || '';
      document.getElementById('phone').value = profile.phone || '';
      document.getElementById('address').value = profile.address || '';
      document.getElementById('passportNumber').value = profile.passportNumber || '';
      document.getElementById('passportExpiry').value = profile.passportExpiry || '';
      document.getElementById('remark').value = profile.remark || '';
      
      if (profile.profilePhoto) {
        capturedPhoto = profile.profilePhoto;
        profilePhoto.value = profile.profilePhoto;
        webcamPreview.innerHTML = `<img src="${profile.profilePhoto}" alt="Profile Photo">`;
      }
      
      if (profile.title === 'NEW CDC') {
        document.getElementById('nrc').value = profile.nrc || '';
        document.getElementById('fatherName').value = profile.fatherName || '';
        document.getElementById('motherName').value = profile.motherName || '';
        document.getElementById('birthdate').value = profile.birthdate || '';
        document.getElementById('placeOfBirth').value = profile.placeOfBirth || '';
        document.getElementById('distinguishingMark').value = profile.distinguishingMark || '';
        document.getElementById('fees').value = profile.fees || '';
        document.getElementById('feesPercentage').value = profile.feesPercentage || '';
        updateProgressBar();
        
        if (profile.certificates) {
          const certs = profile.certificates.split(', ');
          document.querySelectorAll('input[name="certificates"]').forEach(cb => {
            cb.checked = certs.includes(cb.value);
          });
        }
      }
      
      if (profile.title === 'REVALIDATION') {
        if (profile.certificates) {
          const certs = profile.certificates.split(', ');
          const certsContainer = selectedRevalidationType === 'CREW' ? 
            'crewCertificates' : 'officerCertificates';
          
          renderRevalidationDocsIntoForm();
          revalidationDocsContainer.querySelectorAll(`input[name="${certsContainer}"]`).forEach(cb => {
            cb.checked = certs.includes(cb.value);
          });
        }
      }
      
      formTitleText.textContent = 'Edit Profile';
      saveBtn.classList.add('hidden-field');
      updateBtn.classList.remove('hidden-field');
      updateFormFields();
      formContainer.style.display = 'block';
      formContainer.scrollIntoView({behavior: 'smooth'});
    }

    async function exportToCSV(){
      if(profiles.length===0){alert('No data to export');return}
      showLoading('Generating CSV...');
      try{
        let csv="Name,Rank,CDC Number,Phone,Address,Passport Number,Passport Expiry,Title,Revalidation Type,Remark,Certificates";
        if(profiles.some(p=>p.title==='NEW CDC')){
          csv+=",NRC,Father's Name,Mother's Name,Birthdate,Place of Birth,Distinguishing Mark,Fees,Fees Percentage";
        }
        csv+="\n";
        profiles.forEach(p=>{
          const row=[
            `"${p.name}"`,`"${p.rank}"`,`"${p.cdcNumber}"`,`"${p.phone}"`,`"${p.address}"`,
            `"${p.passportNumber||''}"`,`"${p.passportExpiry||''}"`,`"${p.title||''}"`,`"${p.revalidationType||''}"`,
            `"${p.remark||''}"`,`"${p.certificates||''}"`
          ];
          if(p.title==='NEW CDC'){
            row.push(
              `"${p.nrc||''}"`,`"${p.fatherName||''}"`,`"${p.motherName||''}"`,`"${p.birthdate||''}"`,
              `"${p.placeOfBirth||''}"`,`"${p.distinguishingMark||''}"`,`"${p.fees||''}"`,`"${p.feesPercentage||''}"`
            );
          }
          csv+=row.join(',')+"\n";
        });
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;a.download='seaman_profiles_export.csv';a.style.visibility='hidden';
        document.body.appendChild(a);a.click();document.body.removeChild(a);
        updateSyncStatus('Export Complete','connected');
      }catch(err){alert('Export failed: '+err.message)}finally{hideLoading()}
    }

    function showLoading(text='Processing...'){loadingText.textContent=text;loading.style.display='block'}
    function hideLoading(){loading.style.display='none'}

    function showTitleDialog(){
      titleDialog.style.display='block';
      searchContainer.style.display='none';
      formContainer.style.display='none';
      resetTitleOptions();
      titleDialog.scrollIntoView({behavior:'smooth'});
    }

    function hideTitleDialog(){
      titleDialog.style.display='none';
      revalidationDocsContainer.innerHTML='';
      revalidationDocsContainer.classList.add('hidden-field');
    }

    function selectTitle(title){
      selectedTitle=title;
      if(title==='NEW CDC'){
        newCDCOption.classList.add('active');
        revalidationOption.classList.remove('active');
        revalidationSubOptions.classList.remove('active');
      }else if(title==='REVALIDATION'){
        revalidationOption.classList.add('active');
        newCDCOption.classList.remove('active');
        revalidationSubOptions.classList.add('active');
      }
    }

    function selectRevalidationType(type){
      selectedRevalidationType=type;
      if(type==='CREW'){
        crewOption.classList.add('active');
        officerOption.classList.remove('active');
      }else{
        officerOption.classList.add('active');
        crewOption.classList.remove('active');
      }
    }

    function confirmTitleSelection(){
      if(!selectedTitle){alert('Please select a document type');return}
      if(selectedTitle==='REVALIDATION' && !selectedRevalidationType){alert('Please select a revalidation type');return}
      hideTitleDialog();
      showForm();
      renderRevalidationDocsIntoForm();
    }

    function renderRevalidationDocsIntoForm(){
      revalidationDocsContainer.innerHTML='';
      revalidationDocsContainer.classList.add('hidden-field');
      if(selectedTitle!=='REVALIDATION') return;

      const source=(selectedRevalidationType==='CREW')?crewDocsTemplate:officerDocsTemplate;
      if(!source) return;

      const clone=source.cloneNode(true);
      clone.removeAttribute('id');
      clone.querySelectorAll('input[type="checkbox"]').forEach(cb=>{cb.checked=false;cb.disabled=false;});
      clone.classList.remove('hidden-field');
      clone.style.display='block';

      revalidationDocsContainer.appendChild(clone);
      revalidationDocsContainer.classList.remove('hidden-field');
    }

    function resetTitleOptions(){
      selectedTitle='';selectedRevalidationType='';
      [newCDCOption,revalidationOption,crewOption,officerOption,revalidationSubOptions].forEach(el=>el.classList.remove('active'));
      revalidationDocsContainer.innerHTML='';
      revalidationDocsContainer.classList.add('hidden-field');
      document.querySelectorAll('input[name="crewCertificates"],input[name="officerCertificates"]').forEach(cb=>cb.checked=false);
    }

    function showForm(){
      formContainer.style.display='block';
      searchContainer.style.display='none';
      profileForm.reset();
      updateProgressBar();
      editingProfileId = null;

      formTitleText.textContent = 'New Profile Registration';
      saveBtn.classList.remove('hidden-field');
      updateBtn.classList.add('hidden-field');

      if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}
      webcamPreview.innerHTML='<i class="fa-solid fa-camera" style="font-size:50px;opacity:.5; color: var(--light-gray)"></i>';
      capturedPhoto=null;capturePhoto.disabled=true;retakePhoto.disabled=true;

      updateFormFields();
      formContainer.scrollIntoView({behavior:'smooth'});
    }

    function updateFormFields(){
      const newCDCOnlyFields=document.querySelectorAll('.new-cdc-only');
      if(selectedTitle==='NEW CDC'){
        newCDCOnlyFields.forEach(f=>f.classList.remove('hidden-field'));
        rankSelect.innerHTML=`
          <option value="">Select Rank</option>
          <option value="D/R">D/R</option>
          <option value="E/R">E/R</option>
          <option value="ET/R">ET/R</option>
          <option value="G/S">G/S</option>
          <option value="C/CK">C/CK</option>
        `;
        revalidationDocsContainer.classList.add('hidden-field');
        revalidationDocsContainer.innerHTML='';
      }else if(selectedTitle==='REVALIDATION'){
        newCDCOnlyFields.forEach(f=>f.classList.add('hidden-field'));
        if(selectedRevalidationType==='OFFICER'){
          rankSelect.innerHTML=`
            <option value="">Select Officer Rank</option>
            <option value="Master">Master</option>
            <option value="C/O">C/O</option>
            <option value="2/O">2/O</option>
            <option value="3/O">3/O</option>
            <option value="C/E">C/E</option>
            <option value="2/E">2/E</option>
            <option value="3/E">3/E</option>
            <option value="4/E">4/E</option>
            <option value="E/E">E/E</option>
          `;
        }else{
          rankSelect.innerHTML=`
            <option value="">Select Crew Rank</option>
            <option value="BSN">BSN</option>
            <option value="A/B">A/B</option>
            <option value="O/S">O/S</option>
            <option value="FTR">FTR</option>
            <option value="OLR">OLR</option>
            <option value="WPR">WPR</option>
            <option value="D/C">D/C</option>
            <option value="E/C">E/C</option>
            <option value="Cruise Crew">Cruise Crew</option>
          `;
        }
      }
      
      // Restore rank value if editing
      if (editingProfileId) {
        const currentRank = document.getElementById('rank').value;
        if (currentRank) {
          rankSelect.value = currentRank;
        }
      }
    }

    function hideForm(){
      formContainer.style.display='none';
      resetTitleOptions();
      editingProfileId = null;
    }

    function showSearch(){
      searchContainer.style.display='block';
      formContainer.style.display='none';
      titleDialog.style.display='none';
      searchContainer.scrollIntoView({behavior:'smooth'});
    }

    function updateProgressBar(){
      const pct=Number(feesPercentage.value||0);
      feesProgress.style.width=`${pct}%`;
      if(pct<30) feesProgress.style.background='#ef4444';
      else if(pct<70) feesProgress.style.background='#f59e0b';
      else feesProgress.style.background='#10b981';
    }

    function searchProfiles(){
      const term=(searchInput.value||'').toLowerCase();
      const filtered=profiles.filter(p=>
        (p.name&&p.name.toLowerCase().includes(term))||
        (p.rank&&p.rank.toLowerCase().includes(term))||
        (p.cdcNumber&&p.cdcNumber.toLowerCase().includes(term))
      );
      displayProfiles(filtered);
    }

    function searchByDate(){
      const fromDate=dateFrom.value,toDate=dateTo.value;
      if(!fromDate&&!toDate){alert('Please enter at least one date');return}
      const filtered=profiles.filter(p=>{
        if(!p.timestamp) return false;
        const d=new Date(p.timestamp.seconds*1000);
        const from=fromDate?new Date(fromDate):new Date(0);
        const to=toDate?new Date(toDate):new Date();
        from.setHours(0,0,0,0);to.setHours(23,59,59,999);
        return d>=from && d<=to;
      });
      displayProfiles(filtered);
    }

    function displayProfiles(list){
      profileCards.innerHTML='';
      if(list.length===0){
        noResults.innerHTML='<i class="fa-solid fa-magnifying-glass"></i><br>No matching profiles found.';
        noResults.style.display='block';
        profileCards.appendChild(noResults);
        return;
      }
      noResults.style.display='none';
      list.forEach(p=>{
        const card=document.createElement('div');card.className='profile-card';
        const initials=p.name?p.name.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase():'??';
        card.innerHTML=`
          <div class="card-header">
            <div class="card-header-info">
              <div class="card-avatar">${initials}</div>
              <div><h3>${p.name}</h3><p>${p.rank}</p></div>
            </div>
            <div class="card-actions">
              <button class="btn-edit" data-id="${p.id}"><i class="fa-solid fa-edit"></i></button>
              <button class="btn-delete" data-id="${p.id}"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="card-body">
            <div class="card-details">
              <div class="card-detail"><span class="detail-label"><i class="fa-regular fa-id-card"></i> CDC</span><span class="detail-value">${p.cdcNumber}</span></div>
              <div class="card-detail"><span class="detail-label"><i class="fa-solid fa-phone"></i> Phone</span><span class="detail-value">${p.phone}</span></div>
              <div class="card-detail"><span class="detail-label"><i class="fa-solid fa-file"></i> Type</span><span class="detail-value">${p.title||'N/A'}</span></div>
              ${p.certificates?`<div class="card-detail"><span class="detail-label"><i class="fa-solid fa-certificate"></i> Documents</span><span class="detail-value" style="font-size:12px">${p.certificates}</span></div>`:''}
              ${p.title==='NEW CDC'?`
                <div class="card-detail"><span class="detail-label"><i class="fa-solid fa-wallet"></i> Fees</span><span class="detail-value">$${p.fees||'0'}</span></div>
                <div class="card-detail" style="border:none;margin-top:10px"><span class="detail-label">Payment Completion</span><span class="detail-value">${p.feesPercentage||'0'}%</span></div>
                <div class="progress-bar"><div class="progress" style="width:${p.feesPercentage||'0'}%;background:${(p.feesPercentage||0)<100?((p.feesPercentage||0)<50?'#ef4444':'#f59e0b'):'#10b981'}"></div></div>
              `:''}
            </div>
          </div>
        `;
        
        card.querySelector('.btn-edit').addEventListener('click', (e) => {
          e.stopPropagation();
          const profile = profiles.find(prof => prof.id === p.id);
          if (profile) editProfile(profile);
        });
        
        card.querySelector('.btn-delete').addEventListener('click', (e) => {
          e.stopPropagation();
          deleteProfile(p.id);
        });
        
        card.addEventListener('click',()=>{
          const titleText=p.title?`\n\n Document Type: ${p.title}`:'';
          const revText=p.revalidationType?`\nRevalidation Type: ${p.revalidationType}`:'';
          const certText=p.certificates?`\n\n Certificates:\n${p.certificates}`:'';
          const passportText=p.passportNumber?`\n\n Passport:\nNumber: ${p.passportNumber}\nExpiry: ${p.passportExpiry||'N/A'}`:'';
          const remarkText=p.remark?`\n\n Remark:\n${p.remark}`:'';
          const newCDCText=p.title==='NEW CDC'
            ?`\n\n NEW CDC Details:\nNRC: ${p.nrc||'N/A'}\nFather: ${p.fatherName||'N/A'}\nMother: ${p.motherName||'N/A'}\nBirthdate: ${p.birthdate||'N/A'}\nPlace of Birth: ${p.placeOfBirth||'N/A'}\nMark: ${p.distinguishingMark||'N/A'}\nFees: $${p.fees||'0'}\nPaid: ${p.feesPercentage||'0'}%`
            :'';
          alert(`SEAMAN PROFILE\n------------------\nName: ${p.name}\nRank: ${p.rank}\nCDC: ${p.cdcNumber}\nPhone: ${p.phone}\nAddress: ${p.address}${titleText}${revText}${newCDCText}${certText}${passportText}${remarkText}`);
        });
        profileCards.appendChild(card);
      });
    }

    async function startWebcam(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        const video=document.createElement('video');
        video.srcObject=stream;video.autoplay=true;video.playsInline=true;
        webcamPreview.innerHTML='';webcamPreview.appendChild(video);
        capturePhoto.disabled=false;startCamera.disabled=true;
      }catch(err){alert('Unable to access webcam. Please check permissions.')}
    }

    function captureWebcam(){
      if(!stream) return;
      const video=webcamPreview.querySelector('video');
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      canvas.width=video.videoWidth;canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      capturedPhoto=canvas.toDataURL('image/jpeg');profilePhoto.value=capturedPhoto;
      stream.getTracks().forEach(t=>t.stop());stream=null;
      const img=document.createElement('img');img.src=capturedPhoto;
      webcamPreview.innerHTML='';webcamPreview.appendChild(img);
      capturePhoto.disabled=true;retakePhoto.disabled=false;
    }

    function retakeWebcam(){
      capturedPhoto=null;profilePhoto.value='';
      webcamPreview.innerHTML='<i class="fa-solid fa-camera" style="font-size:50px;opacity:.5; color: var(--light-gray)"></i>';
      capturePhoto.disabled=true;retakePhoto.disabled=true;startCamera.disabled=false;
    }
  </script>
</body>
</html>
